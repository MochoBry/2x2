<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat 2x2</title>
  <style>
    :root { --bg:#0b1220; --card:#111a2b; --muted:#8892a6; --text:#e6edf3; --accent:#7cc0ff; --border:#22314d; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,"Helvetica Neue",Arial,sans-serif; background: var(--bg); color: var(--text); }
    header { padding: 20px; border-bottom: 1px solid var(--border); background: linear-gradient(180deg, rgba(124,192,255,0.08), transparent 60%); }
    .container { max-width: 900px; margin: 0 auto; padding: 16px; }
    .row { display: grid; grid-template-columns: 1fr; gap: 12px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 12px; }
    .stack { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    input, button, textarea { font: inherit; }
    input[type="text"] { background: #0d1626; border: 1px solid var(--border); color: var(--text); padding: 10px 12px; border-radius: 12px; outline: none; width: 100%; }
    input[type="text"]:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(124,192,255,0.2); }
    button { background: #14223a; color: var(--text); border:1px solid var(--border); padding: 10px 14px; border-radius: 12px; cursor: pointer; }
    button:hover { border-color: var(--accent); }
    small, .muted { color: var(--muted); }

    .chat { display:grid; grid-template-rows: auto 1fr auto; height: calc(100vh - 160px); gap:12px; }
    #messages { list-style: none; padding: 0; margin: 0; display:flex; flex-direction: column; gap: 8px; overflow-y: auto; }
    .bubble { max-width: 70%; padding: 10px 12px; border:1px solid var(--border); border-radius: 14px; background: #0d1626; }
    .me { align-self: flex-end; background: #0f2238; }
    .meta { display:flex; gap:8px; align-items:center; margin-bottom: 4px; }
    .meta b { font-weight: 600; }
    .meta time { font-size: 12px; color: var(--muted); }

    form { display:flex; gap:10px; }
    .participants { display: flex; flex-direction: column; gap: 12px; }
    #participantsList { list-style: none; margin: 0; padding: 0; display: flex; flex-direction: column; gap: 8px; }
    .participant { display: flex; align-items: center; gap: 10px; padding: 8px 10px; border: 1px solid var(--border); border-radius: 12px; background: #0d1626; }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #ff6161; }
    .status-dot.active { background: #3bd87a; }
    .participant-name { flex: 1; font-weight: 500; }
    .delete-btn { margin-top: 8px; background: transparent; border: 1px solid rgba(255,255,255,0.1); color: var(--muted); padding: 4px 8px; border-radius: 8px; font-size: 12px; align-self: flex-end; }
    .delete-btn:hover { color: #ff7b7b; border-color: #ff7b7b; }
    .participants-empty { color: var(--muted); font-size: 14px; }
    @media (min-width: 720px) {
      .row { grid-template-columns: 2fr 1fr; }
      .chat { height: calc(100vh - 180px); }
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1 style="margin:0 0 8px">ðŸ’¬ Chat 2x2</h1>
    </div>
  </header>

  <main class="container">
    <div class="row">
      <section class="card chat">
        <div class="stack" style="justify-content: flex-end;">
          <div class="stack">
            <label for="name">Escribe tu nick</label>
            <input id="name" type="text" placeholder="Escribe tu nick" style="width:200px" />
          </div>
        </div>

        <ul id="messages" class="card" style="padding:12px; overflow:auto"></ul>

        <form id="messageForm" autocomplete="off">
          <input id="messageInput" type="text" placeholder="Escribe un mensajeâ€¦" maxlength="500" />
          <button type="submit">Enviar</button>
        </form>
      </section>
      <aside class="card participants">
        <div class="stack" style="justify-content: space-between; align-items: flex-start;">
          <h3 style="margin:0">Participantes</h3>
          <span id="participantsCount" class="muted">0</span>
        </div>
        <ul id="participantsList"></ul>
        <p id="participantsEmpty" class="participants-empty" style="display:none">AÃºn no hay participantes.</p>
      </aside>
    </div>
  </main>

  <!-- Firebase CDN (compat) -->
<script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore-compat.js"></script>

  <!-- 2) Sustituye el objeto firebaseConfig con el que te da la consola -->
  <script>
    // ðŸ”§ Reemplaza estos valores por los de tu proyecto Firebase (App Web -> SDK de configuraciÃ³n)
    const firebaseConfig = {
      apiKey: "AIzaSyAzi2MuewrqHcFV_t73id3HMa8svxEyrxc",
      authDomain: "res-bf6b7.firebaseapp.com",
      projectId: "res-bf6b7",
      storageBucket: "res-bf6b7.firebasestorage.app",
      messagingSenderId: "746937668794",
      appId: "1:746937668794:web:993afc2a5a3bb863059e83"
    };
  </script>

  <script>
    // --- Utilidades ---
    function $(sel){ return document.querySelector(sel); }
    function uid(){ return Math.random().toString(36).slice(2, 8) + Math.random().toString(36).slice(2, 8); }
    function getRoom(){
      const url = new URL(window.location.href);
      let room = url.searchParams.get('room');
      if(!room){
        room = 'sala-' + uid();
        url.searchParams.set('room', room);
        history.replaceState({}, '', url.toString());
      }
      return room;
    }
    function fmt(ts){
      if(!ts) return 'enviandoâ€¦';
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      return d.toLocaleString();
    }

    // --- Estado ---
    const storedNameRaw = (localStorage.getItem('chat_name') || '').trim().slice(0,40);
    const storedName = storedNameRaw.replace(/[<>]/g,'');
    const state = {
      room: getRoom(),
      user: null,
      name: storedName || 'AnÃ³nimo',
      rawName: storedName,
      isCreator: false,
      participantRef: null,
      presenceInterval: null
    };
    $('#name').value = state.rawName;

    function syncDisplayName(raw){
      const next = raw.trim().slice(0,40);
      const sanitized = next.replace(/[<>]/g,'');
      state.name = sanitized || 'AnÃ³nimo';
      state.rawName = sanitized;
      if(sanitized){
        localStorage.setItem('chat_name', sanitized);
      } else {
        localStorage.removeItem('chat_name');
      }
      if(state.participantRef){
        state.participantRef.set({
          name: state.name,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          lastSeen: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true }).catch(console.error);
      }
      $('#name').value = state.rawName;
    }

    $('#name').addEventListener('change', (e)=>{
      syncDisplayName(e.target.value);
    });

    // --- Firebase init ---
    // Nota: necesitas haber pegado los <script> CDN de Firebase encima y tu firebaseConfig real.
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Inicia sesiÃ³n anÃ³nima
    auth.signInAnonymously().catch(console.error);

    auth.onAuthStateChanged((user) => {
      state.user = user;
      if(user){
        startChat().catch(console.error);
      }
    });

    async function startChat(){
      const messagesEl = $('#messages');
      const form = $('#messageForm');
      const input = $('#messageInput');

      const roomRef = db.collection('rooms').doc(state.room);
      const msgsRef = roomRef.collection('messages');
      const participantsRef = roomRef.collection('participants');

      async function ensureRoomCreator(){
        try {
          await db.runTransaction(async (tx) => {
            const snap = await tx.get(roomRef);
            if(!snap.exists){
              tx.set(roomRef, {
                creatorUid: state.user.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
              });
              state.isCreator = true;
            } else {
              const data = snap.data() || {};
              state.isCreator = data.creatorUid === state.user.uid;
            }
          });
        } catch (err) {
          console.error(err);
          const docSnap = await roomRef.get();
          const data = docSnap.data() || {};
          state.isCreator = data.creatorUid === state.user.uid;
        }
      }

      await ensureRoomCreator();

      state.participantRef = participantsRef.doc(state.user.uid);
      try {
        await state.participantRef.set({
          name: state.name || 'AnÃ³nimo',
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          lastSeen: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
      } catch (err) {
        console.error('No se pudo registrar el participante', err);
      }

      if(state.presenceInterval){
        clearInterval(state.presenceInterval);
      }
      state.presenceInterval = setInterval(() => {
        if(state.participantRef){
          state.participantRef.set({
            lastSeen: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true }).catch(()=>{});
        }
      }, 15000);

      const participantsList = $('#participantsList');
      const participantsCount = $('#participantsCount');
      const participantsEmpty = $('#participantsEmpty');

      participantsRef.onSnapshot((snap) => {
        const now = Date.now();
        const nodes = [];
        let count = 0;
        snap.forEach((doc) => {
          const data = doc.data() || {};
          const name = data.name || 'AnÃ³nimo';
          const lastSeen = data.lastSeen && data.lastSeen.toDate ? data.lastSeen.toDate() : null;
          const active = lastSeen ? (now - lastSeen.getTime() < 30000) : false;
          count += 1;
          const li = document.createElement('li');
          li.className = 'participant';
          const safeName = name.replace(/[<>]/g,'');
          li.innerHTML = `
            <span class="status-dot ${active ? 'active' : ''}"></span>
            <span class="participant-name">${safeName}</span>
          `;
          nodes.push(li);
        });
        participantsList.innerHTML = '';
        nodes.forEach((node) => participantsList.appendChild(node));
        participantsCount.textContent = count.toString();
        participantsEmpty.style.display = count ? 'none' : 'block';
      });

      // SuscripciÃ³n en tiempo real
      msgsRef.orderBy('createdAt').limit(200).onSnapshot((snap) => {
        messagesEl.innerHTML = '';
        snap.forEach((doc) => {
          const m = doc.data();
          const li = document.createElement('li');
          const mine = state.user && m.uid === state.user.uid;
          li.className = 'bubble' + (mine ? ' me' : '');
          const safeText = (m.text||'').replace(/[<>]/g,'');
          const safeName = (m.name||'AnÃ³nimo').replace(/[<>]/g,'');
          const wrapper = document.createElement('div');
          wrapper.innerHTML = `
            <div class="meta"><b>${safeName}</b> <time>Â· ${fmt(m.createdAt)}</time></div>
            <div>${safeText}</div>
          `;
          li.appendChild(wrapper);
          if(state.isCreator){
            const delBtn = document.createElement('button');
            delBtn.type = 'button';
            delBtn.className = 'delete-btn';
            delBtn.textContent = 'Eliminar';
            delBtn.addEventListener('click', async () => {
              if(confirm('Â¿Eliminar este mensaje?')){
                try {
                  await msgsRef.doc(doc.id).delete();
                } catch (err) {
                  alert('No se pudo eliminar: ' + err.message);
                }
              }
            });
            li.appendChild(delBtn);
          }
          messagesEl.appendChild(li);
        });
        messagesEl.scrollTop = messagesEl.scrollHeight;
      });

      // Enviar mensaje
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const text = (input.value||'').trim();
        if(!text) return;
        const name = (state.name||'AnÃ³nimo').slice(0,40);
        const payload = {
          text: text.slice(0,500),
          name,
          uid: state.user ? state.user.uid : null,
          roomId: state.room,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        try {
          await Promise.all([
            msgsRef.add(payload),
            state.participantRef ? state.participantRef.set({
              name,
              lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true }) : Promise.resolve()
          ]);
          input.value = '';
        } catch (err) {
          alert('Error al enviar: ' + err.message);
        }
      });
    }

    window.addEventListener('beforeunload', () => {
      if(state.presenceInterval){
        clearInterval(state.presenceInterval);
      }
      if(state.participantRef){
        state.participantRef.set({
          lastSeen: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true }).catch(()=>{});
      }
    });
  </script>
</body>
</html>
