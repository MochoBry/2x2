<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat 2x2</title>
  <style>
    :root { --bg:#0b1220; --card:#111a2b; --muted:#8892a6; --text:#e6edf3; --accent:#7cc0ff; --border:#22314d; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,"Helvetica Neue",Arial,sans-serif; background: var(--bg); color: var(--text); }
    header { padding: 20px; border-bottom: 1px solid var(--border); background: linear-gradient(180deg, rgba(124,192,255,0.08), transparent 60%); }
    .container { max-width: 900px; margin: 0 auto; padding: 16px; }
    .row { display: grid; grid-template-columns: 1fr; gap: 12px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 12px; }
    .stack { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    input, button, textarea { font: inherit; }
    input[type="text"] { background: #0d1626; border: 1px solid var(--border); color: var(--text); padding: 10px 12px; border-radius: 12px; outline: none; width: 100%; }
    input[type="text"]:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(124,192,255,0.2); }
    button { background: #14223a; color: var(--text); border:1px solid var(--border); padding: 10px 14px; border-radius: 12px; cursor: pointer; }
    button:hover { border-color: var(--accent); }
    small, .muted { color: var(--muted); }

    .chat { display:grid; grid-template-rows: auto 1fr auto; height: calc(100vh - 160px); gap:12px; }
    #messages { list-style: none; padding: 0; margin: 0; display:flex; flex-direction: column; gap: 8px; overflow-y: auto; }
    .bubble { max-width: 70%; padding: 10px 12px; border:1px solid var(--border); border-radius: 14px; background: #0d1626; }
    .me { align-self: flex-end; background: #0f2238; }
    .meta { display:flex; gap:8px; align-items:center; margin-bottom: 4px; }
    .meta b { font-weight: 600; }
    .meta time { font-size: 12px; color: var(--muted); }

    form { display:flex; gap:10px; }
    @media (min-width: 720px) {
      .row { grid-template-columns: 2fr 1fr; }
      .chat { height: calc(100vh - 180px); }
    }
  .presence{list-style:none;margin:8px 0 0;padding:0;display:flex;flex-wrap:wrap;gap:8px}
.presence-item{display:flex;align-items:center;gap:6px;background:#0d1626;border:1px solid var(--border);border-radius:12px;padding:6px 8px}
.dot{width:8px;height:8px;border-radius:50%;background:#ef4444}
.dot.green{background:#22c55e}
.icon-btn{background:transparent;border:none;cursor:pointer;color:var(--muted);margin-left:8px}
.icon-btn:hover{color:var(--accent)}
</style>
</head>
<body>
  <header>
    <div class="container">
      <h1 style="margin:0 0 8px">Chat 2x2</h1>
    </div>
  </header>

  <main class="container">
    <div class="row">
      <section class="card chat">
        <div class="stack" style="justify-content: space-between;">
          <div>
            <div class="stack">
              <strong>Sala:</strong>
              <code id="roomCode" style="padding:4px 8px; background:#0d1626; border:1px solid var(--border); border-radius:8px"></code>
              <button id="copyBtn" title="Copiar enlace">Copiar enlace</button>
              <button id="newRoomBtn" title="Nueva sala">Nueva sala</button>
              <button id="joinRoomBtn" title="Unirse a sala">Unirse</button>
            </div>
            <small class="muted">Comparte este enlace para invitar a otros.</small>
          </div>
          <div class="stack">
            <label for="name">Tu nombre</label>
            <input id="name" type="text" placeholder="Escribe tu nick" style="width:220px" />
            
            $1Escribe tu nick$2
          </div>
        </div>

        <div id="presenceBox" class="card" style="padding:8px">
          <div class="stack" style="justify-content: space-between;">
            <strong>Usuarios</strong>
            <small id="userCountLabel" class="muted">0</small>
          </div>
          <ul id="presenceList" class="presence"></ul>
        </div>

        <ul id="messages" class="card" style="padding:12px; overflow:auto"></ul>

        <form id="messageForm" autocomplete="off">
          <input id="messageInput" type="text" placeholder="Escribe un mensaje‚Ä¶" maxlength="500" />
          <button type="submit">Enviar</button>
        </form>
      </section>

      
    </div>
  </main>

  <!-- Firebase CDN (compat) -->
<script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore-compat.js"></script>

  <!-- 2) Sustituye el objeto firebaseConfig con el que te da la consola -->
  <script>
    // üîß Reemplaza estos valores por los de tu proyecto Firebase (App Web -> SDK de configuraci√≥n)
    const firebaseConfig = {
      apiKey: "AIzaSyAzi2MuewrqHcFV_t73id3HMa8svxEyrxc",
      authDomain: "res-bf6b7.firebaseapp.com",
      projectId: "res-bf6b7",
      storageBucket: "res-bf6b7.firebasestorage.app",
      messagingSenderId: "746937668794",
      appId: "1:746937668794:web:993afc2a5a3bb863059e83"
    };
  </script>

  <script>
    // --- Utilidades ---
    function $(sel){ return document.querySelector(sel); }
    function uid(){ return Math.random().toString(36).slice(2, 8) + Math.random().toString(36).slice(2, 8); }
    function getRoom(){
      const url = new URL(window.location.href);
      let room = url.searchParams.get('room');
      if(!room){
        room = 'sala-' + uid();
        url.searchParams.set('room', room);
        window.location.replace(url.toString());
      }
      return room;
    }, '', url.toString());
      }
      return room;
    }
    function fmt(ts){
      if(!ts) return 'enviando‚Ä¶';
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      return d.toLocaleString();
    }

    // --- Estado ---
    const state = { room: getRoom(), user: null, name: localStorage.getItem('chat_name') || '', isOwner: false };
    $('#name').value = state.name;
    $('#roomCode').textContent = state.room;
    $('#copyBtn').addEventListener('click', async () => {
      const shareUrl = `${location.origin}${location.pathname}?room=${encodeURIComponent(state.room)}`;
      await navigator.clipboard.writeText(shareUrl);
      $('#copyBtn').textContent = '¬°Copiado!';
      setTimeout(()=> $('#copyBtn').textContent = 'Copiar enlace', 1200);
    });

    $('#name').addEventListener('change', async (e)=>{
      state.name = e.target.value.trim().slice(0,40) || 'An√≥nimo';
      localStorage.setItem('chat_name', state.name);
      try {
        const roomRef = firebase.firestore().collection('rooms').doc(state.room);
        if (state.user) {
          await roomRef.collection('profiles').doc(state.user.uid).set({ name: state.name, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
          await roomRef.collection('members').doc(state.user.uid).set({ name: state.name }, { merge: true });
        }
      } catch(err){ console.warn(err); }
    });
    });

    // --- Firebase init ---
    // Nota: necesitas haber pegado los <script> CDN de Firebase encima y tu firebaseConfig real.
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Inicia sesi√≥n an√≥nima
    auth.signInAnonymously().catch(console.error);

    auth.onAuthStateChanged((user) => {
      state.user = user;
      if(user){
        startChat();
      }
    });

    function startChat(){
      const messagesEl = $('#messages');
      const form = $('#messageForm');
      const input = $('#messageInput');

      const roomRef = db.collection('rooms').doc(state.room);
      const msgsRef = roomRef.collection('messages');

      // Propiedad: due√±o de la sala (primer usuario an√≥nimo que entra)
      async function ensureOwner(){
        const snap = await roomRef.get();
        const data = snap.data() || {};
        if(!data.ownerUid){
          await roomRef.set({ ownerUid: state.user.uid, createdAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
          state.isOwner = true;
        } else {
          state.isOwner = (data.ownerUid === state.user.uid);
        }
      }
      ensureOwner();

      // Presencia y perfiles (conteo de participantes √∫nicos por UID)
      const membersRef = roomRef.collection('members');
      const myMemberRef = membersRef.doc(state.user.uid);
      const profilesRef = roomRef.collection('profiles');

      async function heartbeat(){
        const name = (state.name||'An√≥nimo').slice(0,40);
        await myMemberRef.set({ name, lastActiveAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
        await profilesRef.doc(state.user.uid).set({ name, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
      }
      heartbeat();
      setInterval(()=>{ if(!document.hidden) heartbeat(); }, 20000);
      document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) heartbeat(); });

      membersRef.onSnapshot((snap)=>{
        const list = [];
        const now = Date.now();
        snap.forEach(d=>{
          const m = d.data();
          const last = m.lastActiveAt && m.lastActiveAt.toMillis ? m.lastActiveAt.toMillis() : 0;
          const active = (now - last) < 35000;
          list.push({ name: m.name || 'An√≥nimo', active });
        });
        renderPresence(list);
      });

      profilesRef.onSnapshot((snap)=>{
        const el = document.getElementById('userCountLabel');
        if(el) el.textContent = String(snap.size);
      });

      function renderPresence(list){
        const ul = document.getElementById('presenceList');
        if(!ul) return;
        ul.innerHTML = '';
        list.forEach(p=>{
          const li = document.createElement('li');
          li.className = 'presence-item';
          li.innerHTML = `<span class=\"dot ${p.active ? 'green':'red'}\"></span><span>${p.name}</span>`;
          ul.appendChild(li);
        });
      }

      // Suscripci√≥n en tiempo real
      msgsRef.orderBy('createdAt').limit(200).onSnapshot((snap) => {
        messagesEl.innerHTML = '';
        snap.forEach((doc) => {
          const m = doc.data();
          const li = document.createElement('li');
          const mine = state.user && m.uid === state.user.uid;
          li.className = 'bubble' + (mine ? ' me' : '');
          li.innerHTML = `
            <div class="meta"><b>${(m.name||'An√≥nimo')}</b> <time>¬∑ ${fmt(m.createdAt)}</time></div>
            <div>${(m.text||'').replace(/[<>]/g,'')}</div>
          `;
          if(((state.user && m.uid === state.user.uid) || state.isOwner)){
          const btn=document.createElement('button');
          btn.className='icon-btn';
          btn.title='Eliminar';
          btn.textContent='üóë';
          btn.addEventListener('click', async ()=>{ if(confirm('Eliminar este mensaje?')) await msgsRef.doc(doc.id).delete(); });
          li.querySelector('.meta')?.appendChild(btn);
        }
        messagesEl.appendChild(li);
        });
        messagesEl.scrollTop = messagesEl.scrollHeight;
      });

      // Enviar mensaje
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const text = (input.value||'').trim();
        if(!text) return;
        const name = (state.name||'An√≥nimo').slice(0,40);
        const payload = {
          text: text.slice(0,500),
          name,
          uid: state.user ? state.user.uid : null,
          roomId: state.room,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        try {
          await msgsRef.add(payload);
          input.value = '';
        } catch (err) {
          alert('Error al enviar: ' + err.message);
        }
      });
    }
  </script>
<script>
(function(){
  const newBtn = document.getElementById('newRoomBtn');
  if(newBtn){ newBtn.addEventListener('click', ()=>{
    const room = 'sala-' + (Math.random().toString(36).slice(2, 8) + Math.random().toString(36).slice(2, 8));
    const url = new URL(location.href);
    url.searchParams.set('room', room);
    location.href = url.toString();
  }); }
  const joinBtn = document.getElementById('joinRoomBtn');
  if(joinBtn){ joinBtn.addEventListener('click', ()=>{
    const input = prompt('Nombre de la sala a la que deseas unirte:');
    if(!input) return;
    let room = input.trim();
    room = room.replaceAll(' ', '-').slice(0,60);
    if(!room) return;
    const url = new URL(location.href);
    url.searchParams.set('room', room);
    location.href = url.toString();
  }); }
})();
</script>
</body>
</html>
